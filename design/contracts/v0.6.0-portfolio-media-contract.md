# v0.6.0 포트폴리오 미디어 계약서

## 목적/범위
- v0.6.0에서 요구하는 렌더링(WebGL+Canvas2D), 오디오 큐, UTF-8 회귀, 하드웨어 인코딩 옵션, WS 비동기 정책을 고정한다.
- REST / WebSocket / Redis Streams / 잡 상태 머신 / 오류 코드 규칙을 변경하거나 추가할 때 본 문서를 기준으로 구현한다.

## REST 계약
### 1) UTF-8 왕복 확인용 엔드포인트
- `POST /api/auth/register`, `POST /api/auth/login`
  - `nickname` 필드에 한글+이모지 허용 (`utf8mb4`).
  - 응답의 `user.nickname`은 입력 그대로 반환되어야 한다.
- `GET /api/jobs/{jobId}` / `GET /api/jobs/{jobId}/result`
  - `error_code`, `error_message`는 UTF-8 문자열을 안전하게 전달한다.
- 상태 코드
  - 200/202: 정상
  - 401: 인증 실패
  - 404: 소유권 불일치 또는 존재하지 않는 리소스
  - 409: 상태 머신 위배

### 2) 내보내기 요청
- `POST /api/replays/{replayId}/exports/mp4|thumbnail`
  - 요청 본문 없음.
  - 응답: `{ "schemaVersion": "1", "jobId": "uuid" }`
  - jobId는 재시도 시에도 idempotent해야 함(기존 작업 반환 가능).

## WebSocket 계약
### 1) 공통
- 경로: `/ws/jobs?token=<JWT>`
- 인증 실패 시 406 코드와 메시지 `인증 필요`로 종료.
- 페이로드 JSON 키
  - `schemaVersion`: "1"
  - `event`: `job.progress` | `job.completed` | `job.failed`
  - `jobId`, `replayId`, `type`
  - `progress`(숫자, progress 이벤트), `artifactPath`/`checksum`(completed), `error_code`/`error_message`(failed)
  - `timestamp`: ISO-8601 UTC 문자열

### 2) 재연결/에러 정책
- 클라이언트는 연결 종료 시 1s→2s→4s 지수 백오프 최대 10s 후 재연결 시도.
- 서버는 직렬화 오류 시 로그만 남기고 세션은 유지한다.
- `job.failed` 이벤트 수신 후 동일 jobId의 추가 progress/completed는 전송하지 않는다.

## Redis Streams 계약
### 1) 요청 스트림: `replay.export.request`
- 필드: `schemaVersion=1`, `jobId`, `replayId`, `ownerId`, `type`(MP4|THUMBNAIL), `eventPath`, `outputDir`, `durationMillis`, `preferHw`("true"|"false")
  - `preferHw=true`일 때만 하드웨어 인코더를 우선 시도하며, ffmpeg 인코더 목록(`-encoders`)에 `h264_nvenc|h264_vaapi|h264_qsv`가 없으면 즉시 `HWACCEL_UNAVAILABLE` 폴백을 로그에 남기고 소프트웨어로 진행한다.
  - 하드웨어 인코더 시도 중 ffmpeg가 실패하면 동일 job에서 즉시 `libx264`로 재시도하고 `HWACCEL_HANDSHAKE_FAILED`를 로그로 기록한다(FAILED 금지).

### 2) 진행률 스트림: `replay.export.progress`
- 필드: `schemaVersion=1`, `jobId`, `progress`, `message`

### 3) 결과 스트림: `replay.export.result`
- SUCCEEDED: `schemaVersion=1`, `jobId`, `status=SUCCEEDED`, `artifactPath`, `checksum`, `sizeBytes`, `durationMillis`
- FAILED: `schemaVersion=1`, `jobId`, `status=FAILED`, `error_code`, `error_message`, `logTail`

## 잡 상태 머신
- `QUEUED → RUNNING → (SUCCEEDED | FAILED | CANCELLED)`
- 모든 전이는 JobService를 통해서만 수행.
- `FAILED` 후 동일 jobId로 `progress/completed` 전송 금지.

## 오류 코드(추가/고정)
- 기존: `FFMPEG_EXIT_NONZERO`, `FFMPEG_TIMEOUT`, `FFPROBE_INVALID_OUTPUT`, `EXPORT_TRIVIAL_FRAMES`, `OUTPUT_ATOMIC_MOVE_FAILED`
- 신규:
  - `HWACCEL_UNAVAILABLE` (옵션 켜짐 + 가속 미지원 시 소프트웨어로 폴백하며 로그 기록)
  - `HWACCEL_HANDSHAKE_FAILED`
  - `FFMPEG_ENCODE_ERROR` (ffmpeg 인코딩 실패를 통합적으로 분류)
  - `FAILED_NATIVE_VALIDATION` (Native Helper 검증 실패)
  - `GPU_CONTEXT_LOST` (프런트 렌더러에서 WebGL 컨텍스트가 소실되어 폴백한 경우 기록용)
- 성공 판정: ffprobe 구조 검증 + Native Helper 기반 트리비얼 프레임 가드 통과 시에만 SUCCEEDED.

## Native Helper 계약
- 워커는 10%/90% 지점 프레임을 추출한 뒤 Native Helper로 전달한다.
- Native Helper는 두 프레임의 MSE(또는 유사도)를 계산해 JSON으로 반환한다.
- diff_score가 임계값 이하일 경우 `FAILED_NATIVE_VALIDATION`으로 실패 처리한다.

## UTF-8 회귀 규칙
- DB 컬럼은 utf8mb4로 저장되어야 하며, nickname/타이틀에 한글+이모지가 포함되어도 손실되지 않는다.
- REST/WS 응답 직렬화 시 UTF-8을 그대로 유지한다.

## 퍼포먼스/렌더링 계약
- 리플레이 뷰어는 WebGL 경로를 우선 시도하고 실패 시 Canvas2D로 자동 폴백한다.
- WebAudio 큐를 최소 1개 운용하여 완료 알림음을 재생한다(사용자 입력 후 활성화 고려).
