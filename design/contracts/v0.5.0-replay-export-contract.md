# v0.5.0 리플레이 + 비동기 내보내기 계약서

## 1. 개요
- 대상 버전: v0.5.0 (리플레이 저장 및 MP4/썸네일 내보내기 MVP)
- 준수 문서: `STACK_DESIGN.md`, `PRODUCT_SPEC.md`, `CODING_GUIDE.md`
- 이 계약은 REST/WS/Redis Streams/작업 상태 머신을 고정하며, 구현은 이 스펙을 따라야 한다.

## 2. 공통 규칙
- 모든 외부 노출 데이터는 `schemaVersion` 또는 동등한 버전을 포함한다.
- 시간대: Asia/Seoul, 인코딩: UTF-8/utf8mb4.
- 에러 응답은 `error_code` + `message`를 포함하며, `error_code`는 안정적으로 유지한다.

## 3. REST API
### 3.1 인증
- 모든 엔드포인트는 JWT 인증 필요. (기존 `/api/auth/**`, `/api/health` 제외)

### 3.2 에러 포맷
```json
{
  "error_code": "REPLAY_NOT_FOUND",
  "message": "리플레이를 찾을 수 없습니다."
}
```

### 3.3 엔드포인트 정의
#### GET /api/replays
- 설명: 로그인 사용자의 리플레이 목록 조회 (페이징 가능, 단순 MVP는 전체 반환 허용)
- 요청: `page`/`size` 선택적 쿼리
- 응답 200
```json
{
  "schemaVersion": "1",
  "items": [
    {
      "id": 1,
      "ownerId": 10,
      "title": "매치 1",
      "durationMillis": 12345,
      "createdAt": "2024-01-01T12:00:00Z"
    }
  ]
}
```

#### GET /api/replays/{id}
- 설명: 특정 리플레이 메타데이터 조회
- 응답 200: `schemaVersion`, `id`, `ownerId`, `title`, `durationMillis`, `eventPath`, `createdAt`

#### GET /api/replays/{id}/events
- 설명: JSONL_V1 리플레이 이벤트 다운로드/스트리밍
- 성공 시 `Content-Type: application/jsonl` 또는 `application/octet-stream`과 파일 본문을 전달
- 실패 시 에러 포맷 반환

#### POST /api/replays/{id}/exports/mp4
- 설명: MP4 내보내기 작업 생성 (idempotent)
- 요청 바디: `{ "preset": "default" }` (확장 가능, MVP는 필수값 없음)
- 응답 202
```json
{ "schemaVersion": "1", "jobId": "<uuid>" }
```

#### POST /api/replays/{id}/exports/thumbnail
- 설명: 썸네일 생성 작업 생성 (idempotent)
- 응답 구조는 MP4와 동일

#### GET /api/jobs/{jobId}
- 설명: 작업 상태 조회
- 응답 200
```json
{
  "schemaVersion": "1",
  "id": "<uuid>",
  "replayId": 1,
  "type": "MP4" | "THUMBNAIL",
  "status": "QUEUED" | "RUNNING" | "SUCCEEDED" | "FAILED" | "CANCELLED",
  "progress": 0,
  "error_code": null,
  "error_message": null,
  "createdAt": "...",
  "updatedAt": "..."
}
```

#### GET /api/jobs/{jobId}/result
- 설명: 완료된 산출물 메타 조회 + 다운로드 링크
- 응답 200 (SUCCEEDED일 때)
```json
{
  "schemaVersion": "1",
  "id": "<uuid>",
  "type": "MP4",
  "artifactPath": "/storage/replays/1/export.mp4",
  "checksum": "sha256:...",
  "sizeBytes": 123456,
  "durationMillis": 5000
}
```
- FAILED/CANCELLED 시 에러 포맷 반환

#### GET /api/jobs/{jobId}/download
- 설명: 내보내기 완료 파일 바이너리 다운로드(MP4/PNG)
- 응답 200: `Content-Type`은 타입에 따라 `video/mp4` 또는 `image/png`

## 4. WebSocket 이벤트
- 엔드포인트: `/ws/jobs` (JWT 인증 필요, owner only)
- 공통 필드: `schemaVersion: "1"`, `jobId`, `type`, `timestamp`.
- 이벤트명
  - `job.progress`
  - `job.completed`
  - `job.failed`

### 4.1 job.progress
```json
{
  "event": "job.progress",
  "schemaVersion": "1",
  "jobId": "<uuid>",
  "replayId": 1,
  "type": "MP4",
  "progress": 42,
  "message": "ffmpeg 진행률"
}
```

### 4.2 job.completed
```json
{
  "event": "job.completed",
  "schemaVersion": "1",
  "jobId": "<uuid>",
  "replayId": 1,
  "type": "MP4",
  "artifactPath": "/storage/replays/1/export.mp4",
  "checksum": "sha256:...",
  "durationMillis": 5000
}
```

### 4.3 job.failed
```json
{
  "event": "job.failed",
  "schemaVersion": "1",
  "jobId": "<uuid>",
  "replayId": 1,
  "type": "MP4",
  "error_code": "FFPROBE_INVALID_OUTPUT",
  "error_message": "비디오 스트림을 찾을 수 없습니다."
}
```

## 5. Redis Streams 스키마
- 스트림 키
  - 요청: `replay.export.request`
  - 진행률: `replay.export.progress`
  - 결과: `replay.export.result`
- 공통 필드: `schemaVersion=1`, `jobId`, `replayId`, `type`, `ownerId`, `timestamp`.

### 5.1 요청 메시지 (backend → worker)
- 필드: `schemaVersion`, `jobId`, `replayId`, `type`(`MP4`/`THUMBNAIL`), `eventPath`, `outputDir`, `ownerId`, `durationMillis`.

### 5.2 진행률 메시지 (worker → backend)
- 필드: `schemaVersion`, `jobId`, `progress`(0~100), `message`, `logTail`(선택).

### 5.3 결과 메시지 (worker → backend)
- SUCCEEDED
  - `schemaVersion`, `jobId`, `status=SUCCEEDED`, `artifactPath`, `checksum`, `durationMillis`, `sizeBytes`.
- FAILED
  - `schemaVersion`, `jobId`, `status=FAILED`, `error_code`, `error_message`, `logTail`.

## 6. 작업 상태 머신
```
QUEUED → RUNNING → SUCCEEDED
                   ↘
                    FAILED
QUEUED → CANCELLED (사용자 취소 허용 시)
```
- 전이 규칙
  - `QUEUED`는 오직 `RUNNING` 또는 `CANCELLED`로만 전이
  - `RUNNING`은 `SUCCEEDED` 또는 `FAILED`로만 전이
  - 종단 상태(`SUCCEEDED/FAILED/CANCELLED`) 진입 후 추가 전이 금지
- 진행률 업데이트는 `RUNNING` 상태에서만 허용

## 7. 안정적 error_code 목록
- `REPLAY_NOT_FOUND`: 리플레이 ID 없음 또는 권한 없음
- `JOB_NOT_FOUND`: 작업 ID 없음
- `JOB_ALREADY_COMPLETED`: 종단 작업에 대한 중복 업데이트
- `FFPROBE_INVALID_OUTPUT`: ffprobe 검증 실패
- `EXPORT_TRIVIAL_FRAMES`: 서로 다른 구간 프레임 해시가 동일하여 의미없는 영상으로 판단
- `FFMPEG_EXIT_NONZERO`: ffmpeg 종료 코드 비정상
- `OUTPUT_ATOMIC_MOVE_FAILED`: 임시 파일을 최종 위치로 이동 실패

## 8. 검증 규칙 (worker)
- ffmpeg 종료 코드가 0이라도 즉시 성공 처리 금지
- 성공 조건
  1) ffprobe 결과에 비디오 스트림 1개 이상, duration>0, width/height>0
  2) 10%/90% 구간 프레임 해시 비교 후 상이해야 함 (동일하면 `EXPORT_TRIVIAL_FRAMES`)
- 실패 시 Redis 결과 메시지에 `status=FAILED`, `error_code`, `error_message` 포함

## 9. 호환성/버전 관리
- `schemaVersion` 기본값은 "1"이며, 변경 시 새 버전 항목 추가 필요
- 이 계약은 v0.5.0 구현 전제이며, v0.6.0에서는 추가 필드가 확장될 수 있으나 기존 필드는 유지해야 한다.
