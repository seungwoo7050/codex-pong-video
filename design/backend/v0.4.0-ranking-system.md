# v0.4.0 랭킹 시스템 및 랭크 큐 설계

## 1. 목적 및 범위
- 일반전과 분리된 랭크 큐를 제공하고, 랭크 경기 결과에 따라 사용자 레이팅을 갱신한다.
- 기본적인 글로벌 리더보드를 통해 상위 사용자의 랭크를 확인할 수 있도록 한다.
- v0.4.0 범위에서는 소셜/채팅/토너먼트 기능을 변경하지 않는다.

## 2. 주요 변경 사항 요약
- `users` 테이블: `rating` 정수 컬럼(기본 1200) 추가.
- `game_results` 테이블: `match_type`, `rating_change_a/b`, `rating_after_a/b` 필드로 랭크 결과 기록.
- 별도 엔드포인트로 랭크 큐(`/api/match/ranked`)를 제공하며 기존 일반 큐(`/api/match/quick`)와 분리.
- ELO 기반 `RankingService`로 레이팅 갱신 후 결과를 `GameResultService`에서 함께 저장.
- 리더보드 조회 API(`/api/rank/leaderboard`) 추가.
- WebSocket 게임 이벤트에 `matchType`과 `ratingChange`(랭크 종료 시) 추가.

## 3. 도메인 모델
- **User**: `rating` 필드 추가, 기본값 1200. 랭크 결과에 따라 `updateRating` 호출.
- **GameResult**: 매치 타입, 레이팅 변동, 최종 레이팅을 함께 저장해 프런트에 제공.
- **MatchType**: `NORMAL`/`RANKED` 구분 열거형으로 큐, 방, 이벤트, 기록에 일관 사용.

## 4. 서비스/로직 흐름
1. **매칭**
   - 일반전: `MatchmakingController` → `MatchmakingService.enqueue(user, MatchType.NORMAL)` → `GameRoomService.createRoom(..., NORMAL)`.
   - 랭크전: `RankedMatchmakingController` → `MatchmakingService.enqueue(user, MatchType.RANKED)` → `GameRoomService.createRoom(..., RANKED)`.
   - 각 큐는 별도의 `Queue<User>`로 관리하며 티켓에 `matchType`을 포함.
2. **게임 진행/종료**
   - `GameRoom`이 `matchType`을 유지하며 WebSocket 핸들러가 초기 READY 메시지에 타입을 포함.
   - 틱 루프 종료 시 `GameRoomService.finishRoom` → `GameResultService.recordResult(..., matchType)`.
   - `recordResult`는 랭크전일 때 `RankingService`로 ELO 계산 후 사용자 레이팅을 저장하고, 결과 엔티티에 변동 폭과 최종 레이팅을 기록.
   - 종료 브로드캐스트에 `ratingChange`를 실어 랭크전 클라이언트에 알린다.
3. **레이팅 계산**
   - 기본 레이팅 1200, K-팩터 32.
   - 기대 승률 `1/(1+10^((opp-self)/400))`, 실제 결과(승=1, 무=0.5, 패=0) 기반으로 반영.
   - 계산 후 최소 1점 보장, 양 플레이어 레이팅을 한 번에 업데이트 후 저장.
4. **리더보드**
   - `RankingController`가 `UserRepository.findTop20ByOrderByRatingDesc()`로 상위 20명을 조회.
   - `LeaderboardEntryResponse`로 순위(rank)와 레이팅/닉네임/아바타를 반환.

## 5. API 정의
- `POST /api/match/quick` : 일반 큐 등록 → `{ticketId,status,roomId,matchType:NORMAL}`
- `GET /api/match/quick/{ticketId}` : 일반 큐 상태 조회.
- `POST /api/match/ranked` : 랭크 큐 등록 → `{..., matchType:RANKED}`
- `GET /api/match/ranked/{ticketId}` : 랭크 큐 상태 조회.
- `GET /api/games` : 최근 경기 20건 조회. 응답에 `matchType`, `ratingChangeA/B`, `ratingAfterA/B` 포함.
- `GET /api/rank/leaderboard` : 상위 레이팅 사용자 리스트 반환.

모든 API는 인증 토큰이 필요하며, `/api/auth/*`, `/api/health` 외 엔드포인트는 보호된다.

## 6. WebSocket 이벤트
- 경로: `/ws/game?roomId=...&token=...`
- 서버 메시지 포맷(`GameServerMessage`): `{ type, snapshot, matchType, ratingChange? }`
  - `type`: READY/STATE/FINISHED, `matchType`: NORMAL/RANKED.
  - `ratingChange`: 랭크전 종료 시 `{winnerId?, winnerDelta, loserId?, loserDelta}` 제공, 일반전은 null.

## 7. 테스트 전략
- `RankingFlowTest`: 회원가입/로그인 후 랭크 경기 기록 → 레이팅 변동 및 리더보드 반영 검증.
- `MatchmakingServiceTest`: 일반 큐 매칭 동작 검증(두 사용자 매칭 후 roomId 확인).
- 기존 GameResultControllerTest는 인증 후 조회 가능 여부 확인.

## 8. 마이그레이션/호환성
- `spring.jpa.hibernate.ddl-auto=update` 기준으로 `users.rating` 기본값 1200, `game_results` 신규 컬럼 추가.
- 기존 일반전 API/로직은 동일하게 유지하며, 랭크전만 새 큐와 계산 로직을 사용한다.
