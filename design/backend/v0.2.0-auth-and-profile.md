# v0.2.0 백엔드 설계 - 인증/계정/기본 프로필

## 1. 목적과 범위
- v0.2.0에서 이메일/아이디 기반 계정 시스템을 도입한다.
- JWT로 인증 상태를 유지하며, 닉네임/아바타를 포함한 기본 프로필 CRUD를 제공한다.
- WebSocket 핸드셰이크에 인증 정보를 연결할 수 있는 최소 구조를 마련한다.

## 2. 요구사항 요약
- 회원가입/로그인/로그아웃 REST API 제공.
- 사용자 엔티티: `username`, `password(hash)`, `nickname`, `avatarUrl`, `createdAt`, `updatedAt`.
- 인증 방식: HS256 JWT, Authorization Bearer 헤더.
- 보호된 API: `/api/users/**`, `/api/games/**` 등 사용자 소유 자원은 토큰 필수.
- WebSocket: `/ws/echo` 핸드셰이크 시 JWT를 검증하여 `Principal`로 연결.

## 3. 아키텍처 및 패키지
- `auth`
  - `AuthService`: 회원가입/로그인/토큰 발급.
  - `AuthTokenService`: JWT 생성/검증.
  - `JwtAuthenticationFilter`: HTTP 요청의 Bearer 토큰 파싱.
  - `AuthController`: `/api/auth/*` 엔드포인트.
- `user`
  - `User` 엔티티 + `UserRepository`.
  - `UserService` + `UserController`(`/api/users/me`).
- `config`
  - `SecurityConfig`: stateless 보안 필터 체인, 공개/보호 경로 정의.
  - `WebSocketAuthHandshakeInterceptor`, `WebSocketUserHandshakeHandler`: 핸드셰이크 시 JWT 검증.

## 4. 데이터 모델
- 테이블: `users`
  - `id` BIGINT PK
  - `username` VARCHAR(60) UNIQUE NOT NULL
  - `password` VARCHAR(120) NOT NULL (BCrypt)
  - `nickname` VARCHAR(60) NOT NULL
  - `avatar_url` VARCHAR(255) NULL
  - `created_at`, `updated_at` DATETIME NOT NULL (KST 기준 저장)
- JPA `@PrePersist/@PreUpdate`로 타임스탬프 관리.

## 5. API 설계
- `POST /api/auth/register`
  - 요청: `{ username, password, nickname, avatarUrl? }`
  - 응답: `{ token, expiresAt, user }`
  - 실패: 409(중복 아이디), 400(검증 실패)
- `POST /api/auth/login`
  - 요청: `{ username, password }`
  - 응답: `{ token, expiresAt, user }`
  - 실패: 401(자격 증명 불일치)
- `POST /api/auth/logout`
  - 토큰 폐기 지침만 반환, 서버 상태 변경 없음.
- `GET /api/users/me` (인증 필요)
  - 응답: `UserResponse`
- `PUT /api/users/me` (인증 필요)
  - 요청: `{ nickname, avatarUrl }`
  - 응답: 최신 `UserResponse`
- 게임 API(`/api/games`)는 v0.2.0에서 인증 필요 경로로 유지하여 사용자 소유 액션 보호.

## 6. 인증/보안
- JWT 서명 키: `auth.jwt.secret` 환경변수, 최소 32바이트 이상 문자열 사용.
- 만료: `auth.jwt.expiration-seconds` 기본 3600초.
- SecurityFilterChain: `/api/health`, `/api/auth/*`, `/ws/*`만 공개, 나머지 `authenticated()`.
- 패스워드 해싱: `BCryptPasswordEncoder`.
- 에러 처리: `ResponseStatusException`으로 401/409/404 명시.

## 7. WebSocket 연동
- 핸드셰이크 인터셉터가 `Authorization: Bearer` 또는 `?token=`을 읽어 JWT 검증.
- 성공 시 `AuthenticatedUser`를 세션 속성에 저장, `WebSocketUserHandshakeHandler`가 `Principal` 설정.
- `EchoWebSocketHandler`에서 `Principal` 닉네임을 에코 메시지에 포함해 인증 연결을 검증.

## 8. 테스트 전략
- `AuthIntegrationTest`
  - 회원가입 → 로그인 → `/api/users/me` 조회/수정 플로우 검증.
  - 미인증 접근 시 401 확인.
- `GameResultControllerTest`
  - 토큰을 발급받아 경기 생성/조회 수행.
- 테스트 프로파일: H2 메모리 DB, `application-test.properties`에 JWT 시크릿/DDL 설정.

## 9. 환경 변수 및 이행
- 필수: `AUTH_JWT_SECRET`(길이 32바이트 이상), DB 접속 정보.
- 선택: `AUTH_JWT_EXPIRATION_SECONDS`.
- 도커 컴포즈에 기본 시크릿 제공(로컬 전용), 배포 시 변경 필수.

## 10. 향후 과제
- 비밀번호 재설정/잠금 정책 추가.
- WebSocket 인증 실패 로깅 및 모니터링 지표 연동.
- 프로필 확장 필드(자기소개, 지역 등)와 아바타 업로드 스토리지 연계.
