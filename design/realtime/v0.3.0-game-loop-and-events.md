# v0.3.0 실시간 설계 - 게임 루프/이벤트

## 1. 목적
- 1:1 경기의 WebSocket 이벤트 계약과 서버 틱 루프 파라미터를 정의한다.

## 2. 엔드포인트/인증
- 엔드포인트: `ws://<backend>/ws/game?roomId=<id>&token=<jwt>`
- JWT는 기존 핸드셰이크 인터셉터로 검증, `Principal`을 세션에 주입.
- roomId는 매칭 API로 받은 값만 허용, 참가자가 아닌 경우 연결 거부.

## 3. 틱/물리 파라미터
- 틱 주기: 50ms 고정.
- 코트 크기: 800x480, 패들 높이 80, 공 속도 280px/s.
- 득점 조건: 한쪽 점수가 5점 도달 시 종료.

## 4. 이벤트 계약
- 클라이언트 → 서버
  - `INPUT`
    - payload: `{ type: "INPUT", roomId: string, direction: "UP"|"DOWN"|"STAY" }`
    - 의미: 현재 프레임의 패들 이동 의도.
- 서버 → 클라이언트
  - `READY`
    - `{ type: "READY", snapshot: GameSnapshot }`
    - 첫 연결 시 초기 좌표 전달.
  - `STATE`
    - `{ type: "STATE", snapshot: GameSnapshot }`
    - 매 틱마다 상태 브로드캐스트. `snapshot.finished`가 true이면 곧 종료.

### GameSnapshot 구조
```
{
  roomId: string,
  ballX: number,
  ballY: number,
  ballVelocityX: number,
  ballVelocityY: number,
  leftPaddleY: number,
  rightPaddleY: number,
  leftScore: number,
  rightScore: number,
  targetScore: number,
  finished: boolean
}
```

## 5. 장애/타임아웃 처리
- Nginx `proxy_read_timeout`/`proxy_send_timeout` 120s로 확장.
- 세션 종료/예외 시 방 루프는 다음 틱에서 자연 종료되며, 이미 종료된 방은 `GameRoomService.removeRoom`으로 정리.

## 6. 테스트 노트
- 단위 테스트: `GameEngineTest`로 틱 로직 검증.
- 통합 테스트는 WebSocket 대신 REST 경로, 수동 E2E는 로비→매칭→게임 흐름으로 확인.
